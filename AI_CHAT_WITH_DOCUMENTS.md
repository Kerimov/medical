# 🤖 AI-Чат с прикреплением документов

## 🎉 Что реализовано:

Теперь в AI-ассистенте можно **прикреплять медицинские документы** и AI будет отвечать на вопросы с учетом ваших реальных показателей!

---

## ✨ Возможности:

### 1. Прикрепление документов
- 📎 Кнопка "Прикрепить" в чате
- 📋 Выбор из уже загруженных документов
- ✅ Множественное прикрепление
- 🗑️ Удаление прикрепленных перед отправкой

### 2. Умный анализ
- 🤖 AI видит ВСЕ показатели из документа
- 📊 Понимает какие значения в норме, какие нет
- 💬 Отвечает на вопросы по конкретным анализам
- 🎯 Персонализированные рекомендации

### 3. Визуализация
- 🏷️ Badge с названием документа в сообщении
- 📄 Отображение типа исследования
- 📅 Дата анализа

---

## 🚀 Как использовать:

### Шаг 1: Загрузите документ
```
1. Перейдите в раздел "Документы"
2. Загрузите медицинский анализ (PDF/JPG)
3. Дождитесь завершения обработки (OCR + AI-парсинг)
```

### Шаг 2: Откройте AI-чат
```
1. Нажмите на иконку чата (правый нижний угол)
2. Увидите кнопку 📎 "Прикрепить документ"
```

### Шаг 3: Прикрепите документ
```
1. Кликните на 📎
2. Выберите документ из списка
3. Документ появится над полем ввода
```

### Шаг 4: Задайте вопрос
```
Примеры вопросов:
- "Есть ли у меня отклонения в анализе?"
- "Что означает повышенный гемоглобин?"
- "Нужно ли мне обратиться к врачу?"
- "Расшифруй мои показатели простым языком"
```

---

## 💡 Примеры диалогов:

### Пример 1: Общая оценка

**Вы:**
> 📎 [Общий анализ крови - ДНКОМ]  
> Скажи, все ли у меня в норме?

**AI:**
> Проанализировал ваш анализ крови от 27.10.2022:
> 
> ✅ **Хорошие новости!** Все 23 показателя в пределах нормы:
> - Гемоглобин: 148.1 г/л (норма)
> - Эритроциты: 4.98 млн/мкл (норма)
> - Лейкоциты: в пределах нормы
> - Тромбоциты: в норме
> 
> Ваш анализ крови не выявил никаких отклонений. Это отличный результат! 🎉

### Пример 2: Конкретный показатель

**Вы:**
> 📎 [Общий анализ крови - ДНКОМ]  
> Что такое MCH и почему у меня 30.5?

**AI:**
> MCH (Mean Corpuscular Hemoglobin) - это среднее содержание гемоглобина в одном эритроците.
> 
> Ваш показатель: **30.5 пг**  
> Норма: 27-34 пг  
> Статус: ✅ **В норме**
> 
> Этот показатель помогает оценить:
> - Способность эритроцитов переносить кислород
> - Выявить разные типы анемии
> 
> Ваше значение находится в середине нормального диапазона, что очень хорошо! 👍

### Пример 3: Сравнение анализов

**Вы:**
> 📎 [Анализ крови #1] [Анализ крови #2]  
> Сравни мои анализы, есть ли динамика?

**AI:**
> Сравниваю ваши анализы:
> 
> **Анализ #1 (27.10.2022):**
> - Гемоглобин: 148.1 г/л ✅
> 
> **Анализ #2 (30.05.2021):**
> - СОЭ: повышена до 12 мм/ч ⚠️
> 
> **Выводы:**
> 1. Первый анализ полностью в норме
> 2. Во втором есть небольшое повышение СОЭ
> 3. Рекомендую: контрольный анализ и консультация терапевта

---

## 🔧 Технические детали:

### Архитектура

```
┌──────────────────┐
│  Загрузка PDF    │
│  (Раздел Документы)│
└────────┬─────────┘
         │
         v
┌──────────────────┐
│   OCR + AI       │  ← Извлечение всех показателей
│   Парсинг        │
└────────┬─────────┘
         │
         v
┌──────────────────┐
│  База документов │  ← Хранение структурированных данных
└────────┬─────────┘
         │
         v
┌──────────────────┐
│   AI-Чат         │  ← Прикрепление документов
│   (Paperclip)    │
└────────┬─────────┘
         │
         v
┌──────────────────┐
│  Gemini API      │  ← AI с контекстом документов
│  + Контекст      │
└──────────────────┘
```

### Компоненты:

**Frontend (`components/AIChat.tsx`):**
- `availableDocuments` - список доступных документов
- `selectedDocuments` - выбранные для прикрепления
- `showDocumentSelector` - UI выбора документов
- `attachedDocuments` - отображение в сообщениях

**Backend (`app/api/ai/chat/route.ts`):**
- Прием `documentIds` в запросе
- Загрузка данных из `documentsDb`
- Формирование контекста для AI
- Отправка в Gemini API

### Промпт для AI:

```typescript
Ты - опытный медицинский ассистент.

ВАЖНО:
- Объясняй медицинские термины простым языком
- Если есть отклонения - объясни что они означают
- Не ставь диагнозы - рекомендуй консультацию врача
- Будь эмпатичным и успокаивающим
- Используй данные из прикрепленных документов

ДАННЫЕ ИЗ ДОКУМЕНТОВ:
[ДОКУМЕНТ: анализ.pdf]
Тип: Общий анализ крови
Дата: 27.10.2022
Показатели:
- Гемоглобин: 148.1 г/л (норма: 120-160) ✅
- Эритроциты: 4.98 млн/мкл (норма: 4.0-5.5) ✅
...

Вопрос пациента: {user_message}
```

---

## 🔐 Безопасность:

✅ **Защита данных:**
- Документы доступны только владельцу (проверка `userId`)
- JWT-авторизация для API
- Данные хранятся in-memory (для dev)

✅ **Приватность AI:**
- Google Gemini не использует данные для обучения
- Альтернатива: локальная модель (Ollama)

---

## 📊 Что видит AI:

Для каждого прикрепленного документа AI получает:

```json
{
  "fileName": "Тест анализ крови.pdf",
  "studyType": "Общий анализ крови",
  "studyDate": "2022-10-27",
  "laboratory": "ДНКОМ",
  "indicators": [
    {
      "name": "Гемоглобин (Hb)",
      "value": 148.1,
      "unit": "г/л",
      "referenceMin": 120,
      "referenceMax": 160,
      "isNormal": true
    },
    // ... еще 22 показателя
  ],
  "findings": "Все показатели в пределах нормы..."
}
```

---

## 🎯 Преимущества:

### ДО:
- ❌ AI отвечает общими фразами
- ❌ Нужно вручную вводить показатели
- ❌ Нет персонализации

### ПОСЛЕ:
- ✅ AI видит ваши реальные анализы
- ✅ Персонализированные ответы
- ✅ Точные рекомендации на основе данных
- ✅ Сравнение нескольких анализов
- ✅ Объяснение конкретных отклонений

---

## 🚀 Использование:

### Базовый сценарий:
```
1. Загрузите анализ → AI распознает
2. Откройте чат → Прикрепите документ
3. Спросите → Получите персональный ответ!
```

### Продвинутый сценарий:
```
1. Загрузите несколько анализов
2. Прикрепите все в одном сообщении
3. Спросите: "Какая динамика?"
4. AI сравнит все анализы и даст выводы!
```

---

## 💰 Стоимость:

| Компонент | Провайдер | Цена |
|-----------|-----------|------|
| OCR | OCR.space | Бесплатно |
| Парсинг | OpenAI gpt-4o-mini | ~$0.02/документ |
| Чат | Google Gemini | Бесплатно |

**Итого:** ~$0.02 за анализ + бесплатный чат

---

## 📝 Пример использования:

```typescript
// Frontend
const response = await fetch('/api/ai/chat', {
  method: 'POST',
  body: JSON.stringify({
    message: "Что означает мой анализ?",
    documentIds: ["doc123", "doc456"], // Прикрепленные документы
    history: previousMessages
  })
})

// Backend
// AI получает контекст всех документов
// И отвечает на основе реальных данных!
```

---

**🎊 Готово! Теперь у вас есть персональный медицинский ассистент с доступом к вашим реальным анализам!**

---

## 🆘 Troubleshooting:

**Q: Не вижу документы в списке**  
A: Убедитесь, что документы загружены в разделе "Документы"

**Q: AI не учитывает данные**  
A: Проверьте что документ обработан (есть показатели)

**Q: Ошибка при отправке**  
A: Проверьте `GOOGLE_API_KEY` в `.env.local`

---

**Разработано для Персонального Медицинского Ассистента (ПМА)** 🏥✨

